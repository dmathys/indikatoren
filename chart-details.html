<!DOCTYPE html>
<html lang="de">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=600">

    <title>Indikator</title>

    <link href="assets/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">   
    <link href="assets/css/indikatoren-filter.css" media="screen" rel="stylesheet" type="text/css">
    
    <script src="assets/js/modules/jquery/dist/jquery.min.js" type="text/javascript"></script>    
    <script src="assets/js/modules/filter.js/src/template.js" type="text/javascript"></script>
    <script src="assets/js/url-min.js" type="text/javascript"></script>
    <script src="assets/js/modules/proj4/dist/proj4.js"></script>        
    <script src="assets/js/modules/highcharts/highstock.js" type="text/javascript"></script>
    <script src="assets/js/modules/highcharts/highcharts-more.js" type="text/javascript"></script>    
    <script src="assets/js/modules/highcharts/modules/data.js" type="text/javascript"></script>
    <script src="assets/js/modules/highcharts/modules/map.js" type="text/javascript"></script>
    <!-- load offline-exporting first in order to have functionality available but not override the default behavior of the chart's export buttons  -->
	  <script src="assets/js/modules/highcharts/modules/exporting.js" type="text/javascript"></script>
    <!--script src="assets/js/modules/highcharts/modules/offline-exporting.js" type="text/javascript"></script-->     	  
    <script src="charts/templates/options001.js" type="text/javascript"></script>    
    <script src="metadata/all/templatesById.js" type="text/javascript"></script>
    <script src="assets/js/indikatoren-highcharts.js" type="text/javascript"></script>
    <script src="geojson/wohnviertel_EPSG_2056.js"></script>
    <script src="geojson/rhein_EPSG_2056.js"></script>

    <!--script src="assets/js/modules/html2pdf.js/dist/html2pdf.bundle.min.js"></script-->
    <script src="assets/js/modules/jspdf/dist/jspdf.min.js"></script>
    
    <!--    
    <script type="text/javascript" src="https://canvg.github.io/canvg/rgbcolor.js"></script> 
    <script type="text/javascript" src="https://canvg.github.io/canvg/StackBlur.js"></script>
    <script type="text/javascript" src="https://canvg.github.io/canvg/canvg.js"></script>     
    -->

    <style type="text/css">
      
      body {
        background-color: #fcfcfc;
      }      
      
      .lesehilfe {
        width: 468px;
      }
      
      .bs-logo-link {
        display: block; font-family: Arial, sans-serif; color: black; text-decoration: none; padding: 3px 0px 10px 0px;
      }
      
      .bs-logo-title {
        padding-top: 17px; font-size: 11px;
      }
      
      .bs-logo-text {
        padding-top: 3px; font-weight: 700; font-size: 15px
      }
      
      
      @media print {
        
        .bs-logo-link {
          display: block; font-family: 'Arial'; color: black; text-decoration: none; padding: 10px 0px 10px 0px;
        }
        
        .bs-logo-title {
          padding-top: 17px; font-size: 11px;
        }
        
        .bs-logo-text {
          padding-top: 7px; font-weight: 700; font-size: 15px
        }
        
        body {
          background-color: #fcfcfc;
          font-family: 'Arial';
        }
        
        .highcharts-container {
          margin-left: 41px;
        }
        
        h1{
            font-size: 8pt;
            text-transform: uppercase;
            letter-spacing: none;
            font-weight: bold;
            color: #204453;
            line-height: 100%;
            margin-top: 14px;
            margin-bottom: 8px;
            margin-left: 50px;
            margin-right: 50px;
        }
      
        a {
          text-decoration: none;
          color: inherit;
        }
        
        .lesehilfe {
          width: 468px;
          font-size: 12px;
          margin-left: 50px;
          margin-right: 50px;
        }
        
        .lesehilfe a {
            color: #246036;
            font-size: 12px;
            font-weight: bold;
        }
        
        .link-icon {
            height: 12px;
            width: 15px;
        }
        
        ul {
          list-style-type: none;
          padding: 0px;
        }
        
        #bs-nav {
          display: none;
        }
        
      }
      

      
      
    </style>


  </head>

  <body style="margin: 0;">
    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-KGK459"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KGK459');</script>
    <!-- End Google Tag Manager -->

    <div id="bs-logo">
    	<a class='bs-logo-link' style='display: block; font-family: Arial, sans-serif; color: black; text-decoration: none; padding: 10px 0px 10px 0px;' href="http://www.statistik.bs.ch" title="Startseite">
    		<img class='bs-logo-img' style='float: left; padding: 0px 20px;' src="assets/img/logo-print.png" alt="Logo Kanton Basel-Stadt"/>
    		<div class='bs-logo-title' style='padding-top: 17px; font-size: 11px'>Präsidialdepartement des Kantons Basel-Stadt</div>
    		<div class='bs-logo-text' >Statistisches Amt</div>
    		<p></p>
    	</a>
  	</div>

    <div style='clear: both;'></div>

    <div id='bs-nav' style='background-color: rgb(29, 78, 44); height: 45px; padding: 15px 0px 10px 50px; margin-bottom: 30px;'>
      <a style='color: white; font-size: 13px; font-weight: 700; text-shadow: rgb(23, 62, 35) 0px -1px 0px; text-decoration: none;' href='http://www.statistik.bs.ch/zahlen/indikatoren/portal.html'>
        Indikatoren
      </a>
    </div>
    
    <button id="export">PDF</button>
    <div id="imgContainer" class="hidden"></div>  
    

    <!-- template for chart plus details -->
    <script id="indikator-template-modal-portal" type="text/html">
      <div class="item">
        <div id="container-<%= id %>" indikator-id-data="<%= id %>" indikator-kuerzel-data="<%= kuerzel %>" class="highcharts-wrapper"></div>
        <h1><%= 'Indikator ' + ((isIndikatorensetView(indikatorensetView)) ? kuerzelKunde : kuerzel) %></h1>
        <!-- hide lesehilfe if empty -->
        <div id='lesehilfe' class=<%= (lesehilfe==="" ? "'hidden'": "''" ) %>>
          <h1>Lesehilfe</h1>
          <div class='lesehilfe'><%= lesehilfe %>
          </div>
        </div>                      
        <!-- hide erlaeuterungen info if empty -->
        <div id='erlaeuterungen' class=<%= (erlaeuterungen==="" ? "'hidden'": "''" ) %>>
          <h1>Erläuterungen  und methodische Hinweise</h1>
          <div class='lesehilfe'><%= erlaeuterungen %>
          </div>
        </div>
        <!-- hide Links if empty -->    
        <%= renderLinksHTML((typeof(kennzahlenset)!=='undefined' ? kennzahlenset: null), (typeof(renderLink) !== 'undefined' ? renderLink : null), (typeof(externalLinks)!=='undefined' ? externalLinks : null ), view, stufe1, 'link') %>
      </div>
    </script> 
    
    

    <script type="text/javascript">
            
            
      
      /*  
      global $
      global Highcharts
      global html2pdf
      global templatesById
      global lazyRenderChartById
      global templateBuilder
      */
      
      //"use strict";
      
      //get kuerzel and id from url, encode to prevent xss 
      var id = window.decodeURIComponent($.url('?id'));
      var metadata;
      
      var indikatorensetView = (window.decodeURIComponent($.url('?indikatorensetView')) === 'true') ? true : false;
      var view = window.decodeURIComponent($.url('?view'));
      if (!(view == 'indikatorenset' || view == 'portal' || view == 'print')) {
        view = indikatorensetView;
      }
      
      //check if id is member in the list of existing charts
      if (templatesById[id]){
        $.getJSON('metadata/single/'+ id + '.json').done(function(chartMetadata, textStatus){     
            //retrieve template and merge with json to create html
            var html = $('#indikator-template-modal-portal').html();
            var templateFunction = templateBuilder(html);
            //append generated html
            var container = $('body');
            container.append(templateFunction(chartMetadata));
            
            lazyRenderChartById(id, chartMetadata, view);
            
            metadata = chartMetadata;
            
            /*
            //add pdf button
            var menuItems = Highcharts.getOptions().exporting.buttons.contextButton.menuItems;
            menuItems.push(
            {
                "text": "Einzelansicht PDF", 
                "onclick": function(){    
                  var htmlBody = document.getElementsByTagName('html')[0];
                  html2pdf(htmlBody, 
                    {
                      margin:       1,
                      filename:     id + '.pdf',
                      image:        { type: 'png', quality: 0.98 },
                      html2canvas:  { dpi: 192, letterRendering: false },
                      jsPDF:        { unit: 'cm', format: 'a4', orientation: 'portrait' }
                    });
                }
            });
            */
        });
      }
      else {
        //display error message
        $('body').append('<div class="container"><div class="jumbotron"><h1>Ooops...</h1><p>Kein Chart mit diesem Kürzel bzw. dieser id gefunden.</p></div></div>');
      }
      
      
      function savePDF(imgData){
        var pageWidth = 210,
        	lineHeight = 1.2,
        	margin = 20,
        	maxLineWidth = pageWidth - margin * 2,
        	fontSize = 12,
        	ptsPerInch = 72,
        	oneLineHeight = fontSize * lineHeight / ptsPerInch * 2.54;
        
        var doc = new jsPDF({
          lineHeight: lineHeight
        });
        
        doc.setFontSize(12);
        doc.text(margin, margin + oneLineHeight, "Indikator " + metadata.kuerzel);
        var imgWidth = 120; //mm
        //var imgWidthPx = svg.getBBox().width
        doc.addImage(imgData, 'PNG', 16, margin + 3 * oneLineHeight, 485*imgWidth/485, 415*imgWidth/485);

        var textLines = doc
        	.setFont('helvetica', 'neue')
        	.setFontSize(fontSize)
        	.splitTextToSize(metadata.lesehilfe, maxLineWidth);
        
        doc.text(textLines, margin, 200 /*margin + 2 * oneLineHeight*/);        
        
        doc.save(id + '.pdf');
      }
      

      var createPdfUsingHighchartsOnline = function(){
          var options = Highcharts.charts[0].options;
          var obj = {},
          exportUrl = options.exporting.url;
          //send svg to export server instead of config options: include zoom, tooltips, etc.
          //outerHTML may not work in IE, ployfill required
          obj.svg = $('svg')[0].outerHTML;
          obj.type = 'image/png';
          obj.b64 = true;
          obj.noDownload = true;
          obj.scale = 2.5;

          $.ajax({
              type: 'post',
              url: exportUrl,
              data: obj,
              success: function (data) {
                  data = 'data:image/png;base64,' + data;
                  savePDF(data);
              }
          });
      };
      
      $('#export').click(createPdfUsingHighchartsOnline);  

        
        //========================
        
          
        var createPdfUsingCanvg = function(){
          //source: https://stackoverflow.com/a/33392875/5005585
          //Seems to work fine in IE 11, Chrome 63, Safari 11
          //png is black in Edge, see https://github.com/canvg/canvg/issues/520
          var svg = Highcharts.charts[0].getSVG();
          //console.log(svg);
          var scale = 3;
          var imageWidth = svg.match(/^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/)[1] * scale;
          var imageHeight = svg.match(/^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/)[1] * scale;          
          var mycanvas = document.createElement('canvas');
          mycanvas.width = imageWidth;
          mycanvas.height = imageHeight;
          var ctx = mycanvas.getContext('2d');
          ctx.drawSvg(svg, 0, 0, imageWidth, imageHeight);
          //canvg(mycanvas, svg);
          console.log(mycanvas.width);
          var dataUrl = mycanvas.toDataURL("image/png");
          //console.log(dataUrl);
          savePDF(dataUrl);
        };
        
        
        
        

      
      
            
      
      
      var createPdfUsingHighchartsOffline = function() {
          var imageType = 'image/png';
          var scale = 3;
          var svg = Highcharts.charts[0].getSVG();
          console.log(svg);
          
          var failCallback = function(msg){
            console.log('failedCallBack: ' + msg);
          };
          var objectURLRevoke;
          var win = Highcharts.win;
          var doc = win.document;
          var nav = win.navigator;
          var libURL = Highcharts.getOptions().exporting.libURL;
          
          //imageToDataUrl adapted from highcharts/modules/offline-exporting.src.js
          // PNG/JPEG download - create bitmap from SVG
          var svgurl = Highcharts.svgToDataUrl(svg);
          var finallyHandler = function() {
              try {
                  domurl.revokeObjectURL(svgurl);
              } catch (e) {
                  // Ignore
              }
          };
          // First, try to get PNG by rendering on canvas
          Highcharts.imageToDataUrl(svgurl, imageType, { /* args */ }, scale, function(imageURL) {
                  // Success
                  try {
                      //console.log('imageToDataUrl: ');
                      //console.log(imageURL);
                      savePDF(imageURL)
                      //Highcharts.downloadURL(imageURL, filename);
                      /*
                      if (successCallback) {
                          successCallback();
                      }
                      */
                  } catch (e) {
                      failCallback('failed in imageToDataUrl');
                  }
              }, function() {
                  // Failed due to tainted canvas
                  // Create new and untainted canvas
                  var canvas = doc.createElement('canvas'),
                      ctx = canvas.getContext('2d'),
                      imageWidth = svg.match(/^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/)[1] * scale,
                      imageHeight = svg.match(/^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/)[1] * scale,
                      downloadWithCanVG = function() {
                          ctx.drawSvg(svg, 0, 0, imageWidth, imageHeight);
                          //try {
                              //var filename = 'chart';
                              //Highcharts.downloadURL(nav.msSaveOrOpenBlob ? canvas.msToBlob() : canvas.toDataURL(imageType), filename);
                              savePDF(nav.msSaveOrOpenBlob ? canvas.msToBlob() : canvas.toDataURL(imageType));
                              if (successCallback) {
                                  successCallback();
                              }
                          //} catch (e) {
                          //    failCallback('in downloadWithCanVG catch: ' + e.name + ' ' + e.message);
                          //} finally {
                          //    finallyHandler('in downloadWithCanVG finally');
                          //}
                      };

                  canvas.width = imageWidth;
                  canvas.height = imageHeight;
                  if (win.canvg) {
                      // Use preloaded canvg
                      downloadWithCanVG();
                  } else {
                      // Must load canVG first
                      objectURLRevoke = true; // Don't destroy the object URL yet since we are doing things asynchronously. A cleaner solution would be nice, but this will do for now.
                      getScript(libURL + 'rgbcolor.js', function() { // Get RGBColor.js first
                          getScript(libURL + 'canvg.js', function() {
                              downloadWithCanVG();
                          });
                      });
                  }
              },
              // No canvas support
              failCallback('in imageToDataUrl: No canvas support'),
              // Failed to load image
              failCallback('in imageToDataUrl: failed to load image'),
              // Finally
              function() {
                  if (objectURLRevoke) {
                      finallyHandler();
                  }
              });
        
          /**
           * Downloads a script and executes a callback when done.
           * @param {String} scriptLocation
           * @param {Function} callback
           */
          function getScript(scriptLocation, callback) {
              var head = doc.getElementsByTagName('head')[0],
                  script = doc.createElement('script');
      
              script.type = 'text/javascript';
              script.src = scriptLocation;
              script.onload = callback;
              script.onerror = function() {
                  console.error('Error loading script', scriptLocation); // eslint-disable-line no-console
              };
      
              head.appendChild(script);
          }
        };
        

      //get base64 encoded image
      //see https://gist.github.com/HaNdTriX/7704632
      function toDataURL(src, callback, outputFormat) {
        var img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = function() {
          var canvas = document.createElement('CANVAS');
          var ctx = canvas.getContext('2d');
          var dataURL;
          canvas.height = this.naturalHeight;
          canvas.width = this.naturalWidth;
          ctx.drawImage(this, 0, 0);
          dataURL = canvas.toDataURL(outputFormat);
          callback(dataURL);
        };
        img.src = src;
        if (img.complete || img.complete === undefined) {
          img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
          img.src = src;
        }
      }        
        
        

      
    </script>

  </body>
</html>
